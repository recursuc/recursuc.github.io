<!DOCTYPE HTML>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="../../../sfk/panel/sfk_panel.css" rel="stylesheet" type="text/css" />
    <link href="../../../sfk/accordion/sfk_accordion.css" rel="stylesheet" type="text/css" />
    <link href="../../../sfk/tab/sfk_tab.css" rel="stylesheet" type="text/css" />
    <script src="../../../sfk/sfk.js" type="text/javascript"></script>
    <script src="../../../sfk/panel/sfk_panel.js" type="text/javascript"></script>
    <script src="../../../sfk/accordion/sfk_accordion.js" type="text/javascript"></script>
    <style type="text/css">
        .attrTable
        {
            table-layout: fixed;
            font-size: 11px;
            border-collapse: collapse;
            position: static;
            text-align: left;
            width: 100%;
        }
        
        .attrTable td
        {
            overflow: hidden;
        }
        .attrTable td input
        {
            width: 105px;
        }
    </style>
</head>
<body style="background: rgb(240,240,240); margin: 0px;">
    <form>
    <div id="txtContainer" style="margin: 0px 3px; height: 80%;">
        <ul class="acc_nav" id="barContainer">
            <li>
                <div>
                    <div class="title">
                        基本属性<div class="oper">
                            <a href="#" panel="1">un</a></div>
                    </div>
                    <div class="content">
                        <table class="attrTable" border="1" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="width: 60px;">
                                    节点名称：
                                </td>
                                <td>
                                    <input type="text" wlAttr="Name" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 60px;">
                                    处理人：
                                </td>
                                <td>
                                    <textarea disabled="disabled" wlAttr="AccepterViewNames"></textarea><br />
                                    <input type="button" name="ViewNames" value="选择" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 60px;">
                                </td>
                                <td>
                                    <input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowAddAccepter" />允许添加非设定处理人
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 60px;" rowspan="6">
                                功能选项：
                                </td>
                                <td>
                                    <input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowDelegate" />允许交办代办
                                </td>
                            </tr>
                            <tr>
                            	<td>
                            		<input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowJump" />允许任意跳转
                            	</td>
                            </tr>
                            <tr>
                            	<td>
                            		<input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowCirculation" />允许传阅
                            	</td>
                            </tr>
                            <tr>
                            	<td>
                            		<input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowBack" />允许单步回退
                            	</td>
                            </tr>
                            <tr>
                            	<td>
                            		<input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowBacks" />允许任意回退
                            	</td>
                            </tr>
                            <tr>
                            	<td>
                            		<input style="width: 20px;vertical-align: middle;" type="checkbox" wlAttr="AllowGetBack" />允许收回
                            	</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </li>
            <li>
                <div>
                    <div class="title">
                       数据配置<div class="oper">
                            <a href="#" panel="1">un</a>
                        </div>
                    </div>
                    <div class="content">
                        <table class="attrTable" border="1" cellpadding="0" cellspacing="0">
                        	<!-- <tr>
                                <td style="width:60px"> 表单应用类型：</td>
                                <td>
                                    <select wlAttr="FormAppType" >
                                    	<option value="0" selected="selected">表单集</option>
                                    	<option value="1">单表单</option>
                                    </select>
                                </td>
                            </tr> -->
                            <tr>
                                <td style="width:60px"> 表单集：</td>
                                <td>
                                    <select id="FormTabsId" wlAttr="FormTabsId">
                                    	<option value="0" selected>---请选择---</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                	<table id="FormList">
                                	</table>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </li>
            <li>
                <div>
                    <div class="title">
                       时限配置<div class="oper">
                            <a href="#" panel="1">un</a>
                        </div>
                    </div>
                    <div class="content">
                        <table class="attrTable" border="1" cellpadding="0" cellspacing="0">
                            <tr>
                                <td style="width:60px">
                                    响应时限：
                                </td>
                                <td>
                                <input type="text" wlAttr="RespondLimitNumber" style="width:30px;" />
                                    <select wlAttr="RespondLimitTimeUnit">
	                                    <option value="Month">月</option>
	                                    <option value="Day">天</option>
	                                    <option value="Hour">小时</option>
	                                    <option value="Minute">分</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    处理时限：
                                </td>
                                <td>
                                <input type="text" wlAttr="DisposalLimitNumber" style="width:30px;" />
                                    <select wlAttr="DisposalLimitTimeUnit">
	                                    <option value="Month">月</option>
	                                    <option value="Day">天</option>
	                                    <option value="Hour">小时</option>
	                                    <option value="Minute">分</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    </form>
    <script type="text/javascript">
    window.onload = function () {
        var doc = document,
        url = window.location.href,
        tid = url.substring(url.indexOf("=") + 1, url.length),
            accor = new Accordion({
                target: doc.getElementById("barContainer"),
                container: doc.getElementById("txtContainer"),
                titleStyle: {},
                contentStyle: {},
                mode: 1,
                active: false
            });
		
        window.startObj = parent.workflow.getFigure(tid);
        window.start = startObj.ExtAttributes;
        window.flag = false;

        initFormTabs();
        SetForm();
    }
    
    function changeAttr(element){
    	var newVal = element.value, 
    		oldVal = element.getAttribute("source"), 
    		wlAttr = element.getAttribute("wlAttr"),
    		eType = element.type;
    	if(element.type == "checkbox")
    		newVal = element.checked ? "1" : "0";
   		
       	if(wlAttr == "FormTabsId"){
       		changeFormTabs(newVal);
       		getDataConfig(element);
       	}else{
       		parent.workflow.getCommandStack().execute(new parent.draw2d.CommandAttribute(startObj, wlAttr, newVal, oldVal));
           	element.setAttribute("source", newVal);
       	}
    }
    
    var xnForms;
    function initFormTabs(){
    	//初始化表单集
    	xnForms = window.parent.FormDesign.getNameList();
    	var heFormTabsId = document.getElementById("FormTabsId");
    	for ( var i = 0, len = xnForms.childNodes.length; i < len; i++) {
    		if (xnForms.childNodes[i].nodeType == "1") {
    			var item = new Option(xnForms.childNodes[i].getAttribute("Name"), xnForms.childNodes[i].getAttribute("Id"));
    			heFormTabsId.options.add(item);
    		}
    	}
    }
    
    function changeFormTabs(formTabsId){
    	var heFormList = document.getElementById("FormList");
    	if(formTabsId != "0"){
    		for ( var i = 0, len = xnForms.childNodes.length; i < len; i++) {
        		if (xnForms.childNodes[i].nodeType == "1") {
        			if(xnForms.childNodes[i].getAttribute("Id") == formTabsId){
        				var heTr = "";
        				for ( var j = 0, leng = xnForms.childNodes[i].childNodes.length; j < leng; j++) {
							if(xnForms.childNodes[i].childNodes[j].nodeType == "1"){
								var oFormStates = getFormStates(xnForms.childNodes[i].childNodes[j].getAttribute("Id"));
								var strFormStates = "";
								
								strFormStates += "<option value='0'>请选择</option>";
								for(var n = 0, l = oFormStates.rows.length; n < l ; n++){
									strFormStates += "<option value='"+oFormStates.rows[n].id + "'>" + oFormStates.rows[n].name + "</option>";
								}
								
								heTr += "<tr>"
									+ "<td maintable='" + xnForms.childNodes[i].childNodes[j].getAttribute("MainTable")
									    + "' value=" + xnForms.childNodes[i].childNodes[j].getAttribute("Id")
										+ ">【" + xnForms.childNodes[i].childNodes[j].getAttribute("Name")+ "】</td>"
									+ "<td>"
									+ 	"<select formId='' onchange='getDataConfig()'>" + strFormStates + "</select>"
									+ "</td>"
									+ "</tr>";
							}
        				}
        				heFormList.innerHTML = heTr;
        			}
        		}
    		}
    	}else{
    		heFormList.innerHTML = "";
    	}
    }
    
    function getDataConfig(element){
    	var element = (typeof element !="undefined") ? element: document.getElementById("FormTabsId"), oldVal = element.getAttribute("source");
    	start.FormTabsId = element.value;
		start.FormTabsName = element.options[element.selectedIndex].text;
		start.FormList = getFormListData();
		
   		newVals = [start["FormTabsId"], start["FormTabsName"], start["FormList"]];
		wlAttrs = ["FormTabsId", "FormTabsName", "FormList"];
		parent.workflow.getCommandStack().execute(new parent.draw2d.CommandAttribute(startObj, wlAttrs, newVals, oldVal));
		element.setAttribute("source", start.FormTabsId + "|" + start.FormTabsName + "|" + start.FormList);
    }
    
    function getFormListData(){
    	var heFormList = document.getElementById("FormList");
    	var val = "";
    	for(var n = 0, l = heFormList.rows.length; n < l; n++){
    		var heRow = heFormList.rows[n];
    		val += heRow.cells[0].getAttribute("value") + "," + heRow.cells[0].innerText + "," + heRow.cells[1].firstChild.value + "," + heRow.cells[0].getAttribute("maintable") + ";";
    	} 
    	return val;
    }
    
  //查询表单的状态
    function getFormStates(formId){
    	var formStates = null;
    	$Ajax({
           type: "get",
           url: "formStateAction!getFormStatesByForm?formId=" + formId,
           async: false,
           success: function (xhr, data) {
        	   formStates = eval("(" + xhr.responseText + ")");
           },
           error: function (xhr, error) {
               alert('Failure: ' + xhr.status);
           }
    	});
    	return formStates;
    }
    
    function SetForm() {
        var form = document.forms[0], element, wlAttr, attrVal;
        for (var i = form.length - 1; i >= 0; i--) {
            element = form[i],
            wlAttr = element.getAttribute("wlAttr");
            if(wlAttr != null)
            	attrVal = start["" + wlAttr + ""];
            switch (element.type) {
                case "text":
                	element.value = attrVal;
                    !flag && (addEvent(element, "change", wlAttr), element.setAttribute("source", attrVal));
                    break;
                case "select-one":
                    element.value = attrVal;
                    if(!flag){
                    	if(wlAttr == "RespondLimitTimeUnit" || wlAttr == "DisposalLimitTimeUnit" || wlAttr == "FormTabsId")
                    		addEvent(element, "change", wlAttr);
                    	
                    	if(wlAttr == "FormTabsId"){
                       		element.setAttribute("source", attrVal + "|" + start["FormTabsName"] + "|" + start["FormList"]);
                       		changeFormTabs(attrVal);
                       		
                           	var fs = start["FormList"].split(';');
                           	var heFormList = document.getElementById("FormList");
                           	for(var m = 0, lt = fs.length; m < lt; m++){
                           		if(fs[m] != ""){
       	                    		for(var n = 0, l = heFormList.rows.length; n < l; n++){
       	                        		var heRow = heFormList.rows[n];
       	                        		if(heRow.cells[0].getAttribute("value") == fs[m].split(',')[0]){
       	                        			heRow.cells[1].firstChild.value = fs[m].split(',')[2];
       	                        			break;
       	                        		}
       	                        	} 
                           		}
                           	}
                    	}else{
                    		element.setAttribute("source", attrVal);
                    	}
                    }
                    break;
                case "checkbox":
                	element.checked = attrVal == "1" ? true : false;
                    !flag && (addEvent(element, "click", wlAttr), element.setAttribute("source", attrVal));
                    break;
                case "textarea":
                	element.value = attrVal || "";
                	if(!flag)
                		if(wlAttr == "AccepterViewNames")
                			element.setAttribute("source", start["AccepterIds"] + "," + start["AccepterNames"] + "," + attrVal || "");
                	
                    break;
                case "button":
                	!flag && $E.on(element, "click", function (evt,element) {
                		parent.sDialog.open({
                            title: "组织人员选择",
                            content: {src: "Flow/attribute/personTree.htm"},
                            width: 400,
                            height: 400,
                            onConfirm: function () {
                                    	var reVal = this.heIframe.contentWindow.Submit();
                                    	switch(element.name){
                                        	case "ViewNames":
                                        		start.AccepterIds = reVal[0];
                                        		start.AccepterNames = reVal[2];
                                        		start.AccepterViewNames = reVal[1];
                                        		break;
                                    	}  
                                    	var parObj = element.parentNode.children[0],
	                                		oldVal = parObj.getAttribute("source"), 
	                                		wlAttr = parObj.getAttribute("wlAttr"),
	                                		wlAttrs = [], newVals = [];
	                                	if(parObj.value != reVal[1])
	                                	{
	                                		if(wlAttr == "AccepterViewNames"){
	                                			newVals = [start["AccepterIds"], start["AccepterNames"], start["AccepterViewNames"]];
	                                			wlAttrs = ["AccepterIds", "AccepterNames", "AccepterViewNames"];
	                                		}
	                                		parObj.setAttribute("source", newVals);
	                                		parent.workflow.getCommandStack().execute(new parent.draw2d.CommandAttribute(startObj, wlAttrs, newVals, oldVal.split(",")));
	                                	}
	                                	parObj.value = reVal[1]; 
                                    }
                        });
                    }, element, element);
                	
                	break;
            }
        }
        
        window.flag = true;
    }

    function addEvent(element, type, wlAttr) {
        $E.on(element, type, function () {
        	if(element.type == "checkbox")
        		start["" + wlAttr + ""] = element.checked ? "1" : "0";
        	else
        		start["" + wlAttr + ""] = element.value;
        });
        $E.on(element, "change", function(){
        	changeAttr(element);
        });
    }
    </script>
</body>
</html>
